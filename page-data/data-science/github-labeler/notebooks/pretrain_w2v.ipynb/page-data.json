{"componentChunkName":"component---src-templates-jupyter-notebook-js","path":"/data-science/github-labeler/notebooks/pretrain_w2v.ipynb","result":{"data":{"site":{"siteMetadata":{"title":"Operate First"}},"jupyterNotebook":{"id":"c2b3798e-263d-58c0-b773-3ebcffe32d29 >>> JupyterNotebook","html":"<div class=\"notebook-render\"><div class=\"sc-ifAKCX zMCZx\"><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><h1>Pretrain W2V</h1></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><p>In this notebook, we load in the W2V model with the built vocabukary and train it on as much GHArchive data as we wish. This notebook could theoretically train forever, training on all public github issues ever made</p></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><h2>Load Environment Variables and Model</h2></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[12]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#0000ff\">from</span> google<span class=\"token\" style=\"color:#393A34\">.</span>cloud <span class=\"token\" style=\"color:#0000ff\">import</span> bigquery\n<span class=\"token\" style=\"color:#0000ff\">from</span> google<span class=\"token\" style=\"color:#393A34\">.</span>oauth2 <span class=\"token\" style=\"color:#0000ff\">import</span> service_account\n<span class=\"token\" style=\"color:#0000ff\">import</span> re\n<span class=\"token\" style=\"color:#0000ff\">import</span> datetime\n<span class=\"token\" style=\"color:#0000ff\">import</span> numpy <span class=\"token\" style=\"color:#0000ff\">as</span> np\n<span class=\"token\" style=\"color:#0000ff\">import</span> os\n<span class=\"token\" style=\"color:#0000ff\">from</span> nltk<span class=\"token\" style=\"color:#393A34\">.</span>tokenize <span class=\"token\" style=\"color:#0000ff\">import</span> word_tokenize\n<span class=\"token\" style=\"color:#0000ff\">import</span> nltk\n<span class=\"token\" style=\"color:#0000ff\">from</span> gensim<span class=\"token\" style=\"color:#393A34\">.</span>models <span class=\"token\" style=\"color:#0000ff\">import</span> Word2Vec\n<span class=\"token\" style=\"color:#0000ff\">from</span> dotenv <span class=\"token\" style=\"color:#0000ff\">import</span> find_dotenv<span class=\"token\" style=\"color:#393A34\">,</span> load_dotenv\n<span class=\"token\" style=\"color:#0000ff\">import</span> boto3\n<span class=\"token\" style=\"color:#0000ff\">import</span> sys\n\nvocab_path <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#A31515\">&quot;../src/data&quot;</span>\n<span class=\"token\" style=\"color:#0000ff\">if</span> vocab_path <span class=\"token\" style=\"color:#0000ff\">not</span> <span class=\"token\" style=\"color:#0000ff\">in</span> sys<span class=\"token\" style=\"color:#393A34\">.</span>path<span class=\"token\" style=\"color:#393A34\">:</span>\n    sys<span class=\"token\" style=\"color:#393A34\">.</span>path<span class=\"token\" style=\"color:#393A34\">.</span>insert<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#36acaa\">1</span><span class=\"token\" style=\"color:#393A34\">,</span> vocab_path<span class=\"token\" style=\"color:#393A34\">)</span>\n\n<span class=\"token\" style=\"color:#0000ff\">from</span> w2v_preprocess <span class=\"token\" style=\"color:#0000ff\">import</span> remove_quotes<span class=\"token\" style=\"color:#393A34\">,</span> is_bot<span class=\"token\" style=\"color:#393A34\">,</span> is_english<span class=\"token\" style=\"color:#393A34\">,</span> preprocess<span class=\"token\" style=\"color:#393A34\">,</span> is_punc <span class=\"token\" style=\"color:#008000;font-style:italic\"># noqa</span>\n\nnltk<span class=\"token\" style=\"color:#393A34\">.</span>download<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;punkt&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div><div class=\"sc-htoDjs wOXyQ nteract-outputs\" style=\"max-height:100%\"><div class=\"cell_display\" style=\"max-height:100%;overflow-y:auto\"><code class=\"nteract-display-area-stderr\"><span>[nltk_data] Downloading package punkt to /opt/app-\n[nltk_data]     root/src/nltk_data...\n[nltk_data]   Unzipping tokenizers/punkt.zip.\n</span></code><pre><code><span>True</span></code></pre></div></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[14]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\">load_dotenv<span class=\"token\" style=\"color:#393A34\">(</span>find_dotenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div><div class=\"sc-htoDjs wOXyQ nteract-outputs\" style=\"max-height:100%\"><div class=\"cell_display\" style=\"max-height:100%;overflow-y:auto\"><pre><code><span>True</span></code></pre></div></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[13]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#008000;font-style:italic\"># whether to use ceph or store locally</span>\n\nuse_ceph <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token builtin\">bool</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token builtin\">int</span><span class=\"token\" style=\"color:#393A34\">(</span>os<span class=\"token\" style=\"color:#393A34\">.</span>getenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;USE_CEPH&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">)</span>\n\n<span class=\"token\" style=\"color:#0000ff\">if</span> use_ceph<span class=\"token\" style=\"color:#393A34\">:</span>\n    s3_endpoint_url <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>environ<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&quot;OBJECT_STORAGE_ENDPOINT_URL&quot;</span><span class=\"token\" style=\"color:#393A34\">]</span>\n    s3_access_key <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>environ<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class=\"token\" style=\"color:#393A34\">]</span>\n    s3_secret_key <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>environ<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class=\"token\" style=\"color:#393A34\">]</span>\n    s3_bucket <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>environ<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&quot;OBJECT_STORAGE_BUCKET_NAME&quot;</span><span class=\"token\" style=\"color:#393A34\">]</span>\n\n    s3 <span class=\"token\" style=\"color:#393A34\">=</span> boto3<span class=\"token\" style=\"color:#393A34\">.</span>client<span class=\"token\" style=\"color:#393A34\">(</span>\n        service_name<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#A31515\">&quot;s3&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span>\n        aws_access_key_id<span class=\"token\" style=\"color:#393A34\">=</span>s3_access_key<span class=\"token\" style=\"color:#393A34\">,</span>\n        aws_secret_access_key<span class=\"token\" style=\"color:#393A34\">=</span>s3_secret_key<span class=\"token\" style=\"color:#393A34\">,</span>\n        endpoint_url<span class=\"token\" style=\"color:#393A34\">=</span>s3_endpoint_url<span class=\"token\" style=\"color:#393A34\">,</span>\n    <span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><p>Below we copy over a couple functions from the vocab building notebook that could not easily be imported.</p></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[15]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#008000;font-style:italic\"># save key .json file in the github labeler root</span>\n<span class=\"token\" style=\"color:#008000;font-style:italic\"># project id on bigquery account should match</span>\n\ncredentials <span class=\"token\" style=\"color:#393A34\">=</span> service_account<span class=\"token\" style=\"color:#393A34\">.</span>Credentials<span class=\"token\" style=\"color:#393A34\">.</span>from_service_account_file<span class=\"token\" style=\"color:#393A34\">(</span>\n    <span class=\"token\" style=\"color:#A31515\">&#x27;../github-issue-data-extraction-key.json&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span>\n\nproject_id <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#A31515\">&#x27;github-issue-data-extraction&#x27;</span>\nclient <span class=\"token\" style=\"color:#393A34\">=</span> bigquery<span class=\"token\" style=\"color:#393A34\">.</span>Client<span class=\"token\" style=\"color:#393A34\">(</span>credentials<span class=\"token\" style=\"color:#393A34\">=</span> credentials<span class=\"token\" style=\"color:#393A34\">,</span> project<span class=\"token\" style=\"color:#393A34\">=</span>project_id<span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[16]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#0000ff\">def</span> <span class=\"token\" style=\"color:#393A34\">get_data_for_day</span><span class=\"token\" style=\"color:#393A34\">(</span>day<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token triple-quoted-string\" style=\"color:#A31515\">&quot;&quot;&quot;\n    Pass in a datetime object and a dataframe of all the issue data from that day will be returned.\n    &quot;&quot;&quot;</span>\n    date <span class=\"token\" style=\"color:#393A34\">=</span> day<span class=\"token\" style=\"color:#393A34\">.</span>strftime<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;%Y%m%d&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span>\n    response <span class=\"token\" style=\"color:#393A34\">=</span> client<span class=\"token\" style=\"color:#393A34\">.</span>query<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&quot;&quot;&quot;SELECT JSON_EXTRACT(payload, &#x27;$.issue.title&#x27;) as title,\n                                JSON_EXTRACT(payload, &#x27;$.issue.body&#x27;) as body,\n                                JSON_EXTRACT(payload, &#x27;$.issue.html_url&#x27;) as url,\n                                JSON_EXTRACT(payload, &#x27;$.issue.user.login&#x27;) as actor\n                                FROM githubarchive.day.</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>date<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">\n                                WHERE type = &#x27;IssuesEvent&#x27; AND JSON_EXTRACT(payload, &#x27;$.action&#x27;) = &#x27;&quot;opened&quot;&#x27;\n                                &quot;&quot;&quot;</span></span><span class=\"token\" style=\"color:#393A34\">)</span>\n    df <span class=\"token\" style=\"color:#393A34\">=</span> response<span class=\"token\" style=\"color:#393A34\">.</span>to_dataframe<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span>\n    <span class=\"token\" style=\"color:#0000ff\">return</span> df\n\n\n<span class=\"token\" style=\"color:#0000ff\">def</span> <span class=\"token\" style=\"color:#393A34\">process_df</span><span class=\"token\" style=\"color:#393A34\">(</span>df<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token triple-quoted-string\" style=\"color:#A31515\">&quot;&quot;&quot;Clean the dataframe a bit.&quot;&quot;&quot;</span>\n    <span class=\"token\" style=\"color:#0000ff\">for</span> col <span class=\"token\" style=\"color:#0000ff\">in</span> df<span class=\"token\" style=\"color:#393A34\">.</span>columns<span class=\"token\" style=\"color:#393A34\">:</span>\n        df<span class=\"token\" style=\"color:#393A34\">[</span>col<span class=\"token\" style=\"color:#393A34\">]</span> <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span>col<span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">apply</span><span class=\"token\" style=\"color:#393A34\">(</span>remove_quotes<span class=\"token\" style=\"color:#393A34\">)</span>\n        df <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#393A34\">~</span>df<span class=\"token\" style=\"color:#393A34\">[</span>col<span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">apply</span><span class=\"token\" style=\"color:#393A34\">(</span>is_bot<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">]</span>\n    df <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#393A34\">~</span>df<span class=\"token\" style=\"color:#393A34\">[</span>col<span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">apply</span><span class=\"token\" style=\"color:#393A34\">(</span>is_bot<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">]</span>\n    <span class=\"token\" style=\"color:#0000ff\">return</span> df</code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><p>We load in the previous data. Note it saves as multiple files so we must load all of them in.</p></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[17]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\">pattern <span class=\"token\" style=\"color:#393A34\">=</span> re<span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">compile</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;github-labeler/w2v/.*&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span>\n\nbuck <span class=\"token\" style=\"color:#393A34\">=</span> boto3<span class=\"token\" style=\"color:#393A34\">.</span>resource<span class=\"token\" style=\"color:#393A34\">(</span>\n    service_name<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#A31515\">&quot;s3&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span>\n    aws_access_key_id<span class=\"token\" style=\"color:#393A34\">=</span>s3_access_key<span class=\"token\" style=\"color:#393A34\">,</span>\n    aws_secret_access_key<span class=\"token\" style=\"color:#393A34\">=</span>s3_secret_key<span class=\"token\" style=\"color:#393A34\">,</span>\n    endpoint_url<span class=\"token\" style=\"color:#393A34\">=</span>s3_endpoint_url<span class=\"token\" style=\"color:#393A34\">,</span>\n<span class=\"token\" style=\"color:#393A34\">)</span>\n\nkeys <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#393A34\">]</span>\n\n<span class=\"token\" style=\"color:#0000ff\">for</span> obj <span class=\"token\" style=\"color:#0000ff\">in</span> buck<span class=\"token\" style=\"color:#393A34\">.</span>Bucket<span class=\"token\" style=\"color:#393A34\">(</span>s3_bucket<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">.</span>objects<span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">all</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token\" style=\"color:#0000ff\">if</span> pattern<span class=\"token\" style=\"color:#393A34\">.</span>match<span class=\"token\" style=\"color:#393A34\">(</span>obj<span class=\"token\" style=\"color:#393A34\">.</span>key<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n        keys<span class=\"token\" style=\"color:#393A34\">.</span>append<span class=\"token\" style=\"color:#393A34\">(</span>obj<span class=\"token\" style=\"color:#393A34\">.</span>key<span class=\"token\" style=\"color:#393A34\">)</span>\n\nkeys <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">[</span>os<span class=\"token\" style=\"color:#393A34\">.</span>path<span class=\"token\" style=\"color:#393A34\">.</span>basename<span class=\"token\" style=\"color:#393A34\">(</span>key<span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">for</span> key <span class=\"token\" style=\"color:#0000ff\">in</span> keys<span class=\"token\" style=\"color:#393A34\">]</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[18]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#0000ff\">if</span> use_ceph<span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token\" style=\"color:#0000ff\">for</span> key <span class=\"token\" style=\"color:#0000ff\">in</span> keys<span class=\"token\" style=\"color:#393A34\">:</span>\n        response <span class=\"token\" style=\"color:#393A34\">=</span> s3<span class=\"token\" style=\"color:#393A34\">.</span>get_object<span class=\"token\" style=\"color:#393A34\">(</span>\n            Bucket<span class=\"token\" style=\"color:#393A34\">=</span>s3_bucket<span class=\"token\" style=\"color:#393A34\">,</span>\n            Key<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&quot;github-labeler/w2v/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>key<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&quot;</span></span><span class=\"token\" style=\"color:#393A34\">,</span>\n        <span class=\"token\" style=\"color:#393A34\">)</span>\n        <span class=\"token\" style=\"color:#0000ff\">with</span> <span class=\"token builtin\">open</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&#x27;../models/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>key<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&#x27;</span></span> <span class=\"token\" style=\"color:#393A34\">,</span><span class=\"token\" style=\"color:#A31515\">&#x27;wb&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">as</span> f<span class=\"token\" style=\"color:#393A34\">:</span>\n            <span class=\"token\" style=\"color:#0000ff\">for</span> i <span class=\"token\" style=\"color:#0000ff\">in</span> response<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;Body&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">:</span>\n                f<span class=\"token\" style=\"color:#393A34\">.</span>write<span class=\"token\" style=\"color:#393A34\">(</span>i<span class=\"token\" style=\"color:#393A34\">)</span>\n\nw <span class=\"token\" style=\"color:#393A34\">=</span> Word2Vec<span class=\"token\" style=\"color:#393A34\">.</span>load<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;../models/w2v.model&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><h2>Useful Functions</h2></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><p>We define some useful functions, namely a function to filter unknown words, a function to save w2v models, and a training function to train our model for a given day.</p></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[19]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#0000ff\">def</span> <span class=\"token\" style=\"color:#393A34\">in_set</span><span class=\"token\" style=\"color:#393A34\">(</span>word<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token triple-quoted-string\" style=\"color:#A31515\">&quot;&quot;&quot;Check if the word is in our set.&quot;&quot;&quot;</span>\n    <span class=\"token\" style=\"color:#0000ff\">if</span> word <span class=\"token\" style=\"color:#0000ff\">in</span> w<span class=\"token\" style=\"color:#393A34\">.</span>wv<span class=\"token\" style=\"color:#393A34\">:</span>\n        <span class=\"token\" style=\"color:#0000ff\">return</span> word\n    <span class=\"token\" style=\"color:#0000ff\">else</span><span class=\"token\" style=\"color:#393A34\">:</span>\n        <span class=\"token\" style=\"color:#0000ff\">return</span> <span class=\"token\" style=\"color:#A31515\">&#x27;_unknown_&#x27;</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[20]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#0000ff\">def</span> <span class=\"token\" style=\"color:#393A34\">save_w2v</span><span class=\"token\" style=\"color:#393A34\">(</span>w<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token triple-quoted-string\" style=\"color:#A31515\">&quot;&quot;&quot;Save your w2v model to ceph or just c.&quot;&quot;&quot;</span>\n    w<span class=\"token\" style=\"color:#393A34\">.</span>save<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;../models/w2v.model&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span>\n    <span class=\"token\" style=\"color:#0000ff\">if</span> use_ceph<span class=\"token\" style=\"color:#393A34\">:</span>\n        <span class=\"token\" style=\"color:#0000ff\">for</span> <span class=\"token builtin\">file</span> <span class=\"token\" style=\"color:#0000ff\">in</span> os<span class=\"token\" style=\"color:#393A34\">.</span>listdir<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;../models/&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n            <span class=\"token\" style=\"color:#0000ff\">if</span> <span class=\"token\" style=\"color:#A31515\">&#x27;w2v.model&#x27;</span> <span class=\"token\" style=\"color:#0000ff\">in</span> <span class=\"token builtin\">file</span><span class=\"token\" style=\"color:#393A34\">:</span>\n                s3<span class=\"token\" style=\"color:#393A34\">.</span>upload_file<span class=\"token\" style=\"color:#393A34\">(</span>\n                    Bucket<span class=\"token\" style=\"color:#393A34\">=</span>s3_bucket<span class=\"token\" style=\"color:#393A34\">,</span>\n                    Key<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&quot;github-labeler/w2v/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span><span class=\"token builtin\">file</span><span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&quot;</span></span><span class=\"token\" style=\"color:#393A34\">,</span>\n                    Filename<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&#x27;../models/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span><span class=\"token builtin\">file</span><span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&#x27;</span></span><span class=\"token\" style=\"color:#393A34\">,</span>\n                <span class=\"token\" style=\"color:#393A34\">)</span>\n                os<span class=\"token\" style=\"color:#393A34\">.</span>remove<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&#x27;../models/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span><span class=\"token builtin\">file</span><span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&#x27;</span></span><span class=\"token\" style=\"color:#393A34\">)</span>\n    <span class=\"token\" style=\"color:#0000ff\">return</span> <span class=\"token\" style=\"color:#36acaa\">True</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[21]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#0000ff\">def</span> <span class=\"token\" style=\"color:#393A34\">train_w2v_on_day</span><span class=\"token\" style=\"color:#393A34\">(</span>w<span class=\"token\" style=\"color:#393A34\">,</span> day<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    df <span class=\"token\" style=\"color:#393A34\">=</span> get_data_for_day<span class=\"token\" style=\"color:#393A34\">(</span>day<span class=\"token\" style=\"color:#393A34\">)</span>\n    df <span class=\"token\" style=\"color:#393A34\">=</span> process_df<span class=\"token\" style=\"color:#393A34\">(</span>df<span class=\"token\" style=\"color:#393A34\">)</span>\n    df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;proc&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span> <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;title&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span>fillna<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27; &#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#393A34\">+</span> <span class=\"token\" style=\"color:#A31515\">&#x27; SEP &#x27;</span> <span class=\"token\" style=\"color:#393A34\">+</span> df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;body&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span>fillna<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27; &#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span>\n    df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;proc&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span> <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;proc&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">apply</span><span class=\"token\" style=\"color:#393A34\">(</span>preprocess<span class=\"token\" style=\"color:#393A34\">)</span>\n    df <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span>df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;proc&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">apply</span><span class=\"token\" style=\"color:#393A34\">(</span>is_english<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">]</span>\n    df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;proc&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span> <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;proc&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">apply</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#0000ff\">lambda</span> x<span class=\"token\" style=\"color:#393A34\">:</span> x<span class=\"token\" style=\"color:#393A34\">.</span>lower<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">)</span>\n    inp <span class=\"token\" style=\"color:#393A34\">=</span> df<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;proc&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">.</span><span class=\"token builtin\">apply</span><span class=\"token\" style=\"color:#393A34\">(</span>word_tokenize<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">.</span>values\n    inp <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#393A34\">[</span>in_set<span class=\"token\" style=\"color:#393A34\">(</span>word<span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">for</span> word <span class=\"token\" style=\"color:#0000ff\">in</span> issue <span class=\"token\" style=\"color:#0000ff\">if</span> <span class=\"token\" style=\"color:#0000ff\">not</span> is_punc<span class=\"token\" style=\"color:#393A34\">(</span>word<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">]</span> <span class=\"token\" style=\"color:#0000ff\">for</span> issue <span class=\"token\" style=\"color:#0000ff\">in</span> inp<span class=\"token\" style=\"color:#393A34\">]</span>\n    w<span class=\"token\" style=\"color:#393A34\">.</span>train<span class=\"token\" style=\"color:#393A34\">(</span>inp<span class=\"token\" style=\"color:#393A34\">,</span> total_examples <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token builtin\">len</span><span class=\"token\" style=\"color:#393A34\">(</span>inp<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">,</span> epochs <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#36acaa\">1</span><span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><h2>Model Training</h2></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><p>We will be training the model on random days in a certain interval. We will save the range of these dates as well as the days we have already trained on. This is because the process will likely get interrupted before finishing, especially if being run locally. We come up with methods to save and retrieve the dates locally or from ceph.</p></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[30]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#008000;font-style:italic\"># see if dates file exists</span>\n\ndates_exist <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#36acaa\">True</span>\n\n<span class=\"token\" style=\"color:#0000ff\">if</span> use_ceph<span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token\" style=\"color:#0000ff\">try</span><span class=\"token\" style=\"color:#393A34\">:</span>\n        response <span class=\"token\" style=\"color:#393A34\">=</span> s3<span class=\"token\" style=\"color:#393A34\">.</span>get_object<span class=\"token\" style=\"color:#393A34\">(</span>\n            Bucket<span class=\"token\" style=\"color:#393A34\">=</span>s3_bucket<span class=\"token\" style=\"color:#393A34\">,</span>\n            Key<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#A31515\">&quot;github-labeler/w2v_dates.txt&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span>\n        <span class=\"token\" style=\"color:#393A34\">)</span>\n        <span class=\"token\" style=\"color:#0000ff\">with</span> <span class=\"token builtin\">open</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;w2v_dates.txt&#x27;</span> <span class=\"token\" style=\"color:#393A34\">,</span><span class=\"token\" style=\"color:#A31515\">&#x27;wb&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">as</span> f<span class=\"token\" style=\"color:#393A34\">:</span>\n            <span class=\"token\" style=\"color:#0000ff\">for</span> i <span class=\"token\" style=\"color:#0000ff\">in</span> response<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;Body&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">:</span>\n                f<span class=\"token\" style=\"color:#393A34\">.</span>write<span class=\"token\" style=\"color:#393A34\">(</span>i<span class=\"token\" style=\"color:#393A34\">)</span>\n    <span class=\"token\" style=\"color:#0000ff\">except</span> s3<span class=\"token\" style=\"color:#393A34\">.</span>exceptions<span class=\"token\" style=\"color:#393A34\">.</span>NoSuchKey<span class=\"token\" style=\"color:#393A34\">:</span>\n        dates_exist <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#36acaa\">False</span>\n\n<span class=\"token\" style=\"color:#0000ff\">else</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token\" style=\"color:#0000ff\">if</span> <span class=\"token\" style=\"color:#0000ff\">not</span> os<span class=\"token\" style=\"color:#393A34\">.</span>path<span class=\"token\" style=\"color:#393A34\">.</span>isfile<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;w2v_dates.txt&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n        dates_exist <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#36acaa\">False</span>\n\n<span class=\"token\" style=\"color:#008000;font-style:italic\"># read them in if they exist</span>\n\n<span class=\"token\" style=\"color:#0000ff\">if</span> dates_exist<span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token\" style=\"color:#0000ff\">with</span> <span class=\"token builtin\">open</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;w2v_dates.txt&#x27;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&#x27;r&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">as</span> f<span class=\"token\" style=\"color:#393A34\">:</span>\n        dates <span class=\"token\" style=\"color:#393A34\">=</span> f<span class=\"token\" style=\"color:#393A34\">.</span>readlines<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span>\n        dates <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">[</span>d<span class=\"token\" style=\"color:#393A34\">.</span>replace<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;\\n&#x27;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&#x27;&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">for</span> d <span class=\"token\" style=\"color:#0000ff\">in</span> dates <span class=\"token\" style=\"color:#0000ff\">if</span> d<span class=\"token\" style=\"color:#393A34\">]</span>\n        all_days <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">[</span>datetime<span class=\"token\" style=\"color:#393A34\">.</span>datetime<span class=\"token\" style=\"color:#393A34\">.</span>strptime<span class=\"token\" style=\"color:#393A34\">(</span>d<span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&#x27;%Y-%m-%d&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">for</span> d <span class=\"token\" style=\"color:#0000ff\">in</span> dates<span class=\"token\" style=\"color:#393A34\">]</span>\n\n<span class=\"token\" style=\"color:#008000;font-style:italic\"># start 10 days ago and go back 2 years</span>\n\n<span class=\"token\" style=\"color:#0000ff\">else</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    interval_end <span class=\"token\" style=\"color:#393A34\">=</span> datetime<span class=\"token\" style=\"color:#393A34\">.</span>datetime<span class=\"token\" style=\"color:#393A34\">.</span>today<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">.</span>date<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#393A34\">-</span> datetime<span class=\"token\" style=\"color:#393A34\">.</span>timedelta<span class=\"token\" style=\"color:#393A34\">(</span>days <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#36acaa\">10</span><span class=\"token\" style=\"color:#393A34\">)</span>\n    days <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#36acaa\">365</span><span class=\"token\" style=\"color:#393A34\">*</span><span class=\"token\" style=\"color:#36acaa\">2</span>\n    all_days <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">[</span>interval_end <span class=\"token\" style=\"color:#393A34\">-</span> datetime<span class=\"token\" style=\"color:#393A34\">.</span>timedelta<span class=\"token\" style=\"color:#393A34\">(</span>days <span class=\"token\" style=\"color:#393A34\">=</span> num<span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">for</span> num <span class=\"token\" style=\"color:#0000ff\">in</span> <span class=\"token builtin\">range</span><span class=\"token\" style=\"color:#393A34\">(</span>days<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">]</span>\n\n\n<span class=\"token\" style=\"color:#0000ff\">def</span> <span class=\"token\" style=\"color:#393A34\">save_dates</span><span class=\"token\" style=\"color:#393A34\">(</span>days<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token triple-quoted-string\" style=\"color:#A31515\">&quot;&quot;&quot;Convert a list of datetimes to strings and save them.&quot;&quot;&quot;</span>\n    <span class=\"token\" style=\"color:#0000ff\">with</span> <span class=\"token builtin\">open</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;w2v_dates.txt&#x27;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&#x27;w&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">as</span> f<span class=\"token\" style=\"color:#393A34\">:</span>\n        days <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">[</span>datetime<span class=\"token\" style=\"color:#393A34\">.</span>datetime<span class=\"token\" style=\"color:#393A34\">.</span>strftime<span class=\"token\" style=\"color:#393A34\">(</span>d<span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&#x27;%Y-%m-%d&#x27;</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">for</span> d <span class=\"token\" style=\"color:#0000ff\">in</span> days<span class=\"token\" style=\"color:#393A34\">]</span>\n        f<span class=\"token\" style=\"color:#393A34\">.</span>write<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&#x27;\\n&#x27;</span><span class=\"token\" style=\"color:#393A34\">.</span>join<span class=\"token\" style=\"color:#393A34\">(</span>days<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">)</span>\n    <span class=\"token\" style=\"color:#0000ff\">if</span> use_ceph<span class=\"token\" style=\"color:#393A34\">:</span>\n        s3<span class=\"token\" style=\"color:#393A34\">.</span>upload_file<span class=\"token\" style=\"color:#393A34\">(</span>\n            Bucket<span class=\"token\" style=\"color:#393A34\">=</span>s3_bucket<span class=\"token\" style=\"color:#393A34\">,</span>\n            Key<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#A31515\">&quot;github-labeler/w2v_dates.txt&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span>\n            Filename<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#A31515\">&#x27;w2v_dates.txt&#x27;</span><span class=\"token\" style=\"color:#393A34\">,</span>\n        <span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[ ]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\">initial <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token builtin\">len</span><span class=\"token\" style=\"color:#393A34\">(</span>all_days<span class=\"token\" style=\"color:#393A34\">)</span>\n\n<span class=\"token\" style=\"color:#0000ff\">while</span> all_days<span class=\"token\" style=\"color:#393A34\">:</span>\n    random_day <span class=\"token\" style=\"color:#393A34\">=</span> np<span class=\"token\" style=\"color:#393A34\">.</span>random<span class=\"token\" style=\"color:#393A34\">.</span>choice<span class=\"token\" style=\"color:#393A34\">(</span>all_days<span class=\"token\" style=\"color:#393A34\">)</span>\n    all_days<span class=\"token\" style=\"color:#393A34\">.</span>remove<span class=\"token\" style=\"color:#393A34\">(</span>random_day<span class=\"token\" style=\"color:#393A34\">)</span>\n    train_w2v_on_day<span class=\"token\" style=\"color:#393A34\">(</span>w<span class=\"token\" style=\"color:#393A34\">,</span> random_day<span class=\"token\" style=\"color:#393A34\">)</span>\n    <span class=\"token\" style=\"color:#0000ff\">if</span> <span class=\"token builtin\">len</span><span class=\"token\" style=\"color:#393A34\">(</span>all_days<span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#393A34\">%</span> <span class=\"token\" style=\"color:#36acaa\">3</span> <span class=\"token\" style=\"color:#393A34\">==</span> <span class=\"token\" style=\"color:#36acaa\">0</span><span class=\"token\" style=\"color:#393A34\">:</span>\n        <span class=\"token\" style=\"color:#0000ff\">print</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&#x27;</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>initial <span class=\"token\" style=\"color:#393A34\">-</span> <span class=\"token builtin\">len</span><span class=\"token\" style=\"color:#393A34\">(</span>all_days<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\"> days trained on&#x27;</span></span><span class=\"token\" style=\"color:#393A34\">)</span>\n        save_w2v<span class=\"token\" style=\"color:#393A34\">(</span>w<span class=\"token\" style=\"color:#393A34\">)</span>\n        save_dates<span class=\"token\" style=\"color:#393A34\">(</span>all_days<span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div></div></div>","fields":{"srcLink":"https://github.com/aicoe-aiops/github-labeler/blob/master/notebooks/pretrain_w2v.ipynb"}}},"pageContext":{"id":"c2b3798e-263d-58c0-b773-3ebcffe32d29 >>> JupyterNotebook"}},"staticQueryHashes":["1764348645","2823140819","3000541721","3606484676"]}