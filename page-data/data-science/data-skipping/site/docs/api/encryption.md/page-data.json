{"componentChunkName":"component---src-templates-markdown-remark-js","path":"/data-science/data-skipping/site/docs/api/encryption.md","result":{"data":{"site":{"siteMetadata":{"title":"Operate First"}},"markdownRemark":{"id":"fca7be92-c30c-5d1c-8226-f1a5f9524707","html":"<!--\n -- Copyright 2021 IBM Corp.\n -- SPDX-License-Identifier: Apache-2.0\n -->\n<h1 id=\"encrypting-indexes\" style=\"position:relative;\"><a href=\"#encrypting-indexes\" aria-label=\"encrypting indexes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Encrypting Indexes</h1>\n<p>When using Parquet Metadata Store, The metadata can\noptionally be encrypted using Parquet Modular Encryption (PME).\nThis is achieved since the metadata itself is stored as a Parquet dataset,\nand thus PME can be used to encrypt it.\nThis feature applies to all input formats, for example, a dataset stored\nin CSV format can have its metadata encrypted using PME.</p>\n<p>!!! note\nIn the following sections, unless said otherwise, when referring\nto footers, columns etc., these are with respect to the metadata objects,\nand not the objects in the indexed dataset.</p>\n<h2 id=\"modularity\" style=\"position:relative;\"><a href=\"#modularity\" aria-label=\"modularity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Modularity</h2>\n<p>Index Encryption is modular and is granular in the following way:</p>\n<ul class=\"pf-c-list\">\n<li>Each Index can either be encrypted (with a per-index key granularity) or left plaintext.</li>\n<li>\n<p>Footer + object name column + partition key values:</p>\n<ul class=\"pf-c-list\">\n<li>\n<p>The footer of the metadata object (in itself a Parquet file) contains (among other things):</p>\n<ul class=\"pf-c-list\">\n<li>Schema of the metadata object, which reveals the types, parameters and column names for\nall indexes collected (for example, one can learn that a Bloom Filter Index is defined on column\n<code class=\"language-text\">city</code> with false-positive probability <code class=\"language-text\">0.1</code>)</li>\n<li>Full path of the original dataset (or table name in case of a Hive Metastore table)</li>\n</ul>\n</li>\n<li>The object name column stores the names of all indexed objects, and their\nmodification timestamps at indexing time.</li>\n<li>The partition key values (for example, when Hive Style partitioning is used in the indexed dataset)\nare automatically stored by Xskipper, each virtual column in its own dedicated column.</li>\n</ul>\n</li>\n</ul>\n<p>The footer + object name column + partition columns are encrypted using the same key - the “footer key”,\nunless Plaintext footer is specified, in that case the object name column and the partition\ncolumns will still be encrypted, but the footer itself will be left plaintext (that is,\nthe plaintext footer mode of PME will be activated).\nIf at least 1 index is encrypted then the footer key must be set.</p>\n<p>This granularity enables usecases where different users have access to different subsets of the indexes in the metadata.\nIn general, Xskipper will only try to access the indexes relevant for the query (based on the predicates in the <code class=\"language-text\">WHERE</code>  clause) - and thus\nit’s enough to only have access to the footer key and the keys for the relevant indexes.\nThus, with an appropriate key selection, a single copy of the metadata can be used by different users, with each user having the keys for the indexes\nrelevant to the columns they have access to in the data.</p>\n<p>!!! warning\nXskipper doesn’t have a fallback mechanism for index access, so even if the user has access to a subset of the indexes\nthat is able to provide some skipping, if there are usable indexes for the query which are unaccessible - Xskipper will not be able to provide\nany skipping, the query will succeed but no skipping will happen - for example,\nsay we have a <code class=\"language-text\">MinMax</code> on <code class=\"language-text\">temp</code> and <code class=\"language-text\">ValueList</code> on <code class=\"language-text\">city</code> but we can only access the footer key + the key\nfor the <code class=\"language-text\">MinMax</code> and we run a query with <code class=\"language-text\">WHERE city = &#39;PARIS&#39; AND temp &lt; 5</code> - even though we could use just the <code class=\"language-text\">MinMax</code>\nto get some skipping (though probably not all) - no skipping will occur.</p>\n<h3 id=\"how-to-choose-keys\" style=\"position:relative;\"><a href=\"#how-to-choose-keys\" aria-label=\"how to choose keys permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to choose keys</h3>\n<p>As mentioned before, if an index is not required for a query, Xskipper won’t try to access it,\nand so the only factor for whether Xskipper tries to access an index is whether it’s required for a query - and NOT whether it’s accessible.\nthus, a good practice would be to make sure that if someone has access to a column, they will also have access to the indexes defined for that column (and of course the footer).</p>\n<h2 id=\"usage-flow\" style=\"position:relative;\"><a href=\"#usage-flow\" aria-label=\"usage flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Usage Flow</h2>\n<p>!!! danger\nWhen using index encryption, whenever a “key” is configured in any Xskipper API,\nit’s always the label - <strong>NEVER</strong> the key itself.</p>\n<p>In the following code examples we omit the PME configuration part as it varies between different implementations.\nA demonstrational KMS example can be found <a href=\"https://spark.apache.org/docs/latest/sql-data-sources-parquet.html#columnar-encryption\">here</a></p>\n<h3 id=\"index-creation-flow\" style=\"position:relative;\"><a href=\"#index-creation-flow\" aria-label=\"index creation flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Index Creation Flow</h3>\n<center>\n![Encrypted Index Creation Flow](../img/encryption_index_creation_flow.svg)\n</center>\n<p>Once the metadata is created, subsequent usages (both querying and refreshing) are\nall agnostic to the fact that this metadata is encrypted - so, except for the regular\nPME configurations (KMS, auth etc.) - everything remains the same.</p>\n<h4 id=\"sample-1---creating-metadata-with-encrypted-footer-default\" style=\"position:relative;\"><a href=\"#sample-1---creating-metadata-with-encrypted-footer-default\" aria-label=\"sample 1   creating metadata with encrypted footer default permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sample 1 - Creating metadata with encrypted footer (default)</h4>\n<p>=== “Python”</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">``` python\n# configure footer key\nconf = dict([(&quot;io.xskipper.parquet.encryption.footer.key&quot;, &quot;k1&quot;)])\nxskipper.setConf(conf)\n# adding the indexes\nxskipper.indexBuilder() \\\n.addMinMaxIndex(&quot;temp&quot;, &quot;k2&quot;) \\\n.addValueListIndex(&quot;city&quot;) \\\n.build(reader) \\\n.show(10, False)\n```</code></pre></div>\n<p>=== “Scala”</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">``` scala\n// set the footer key\nval conf = Map(\n  &quot;io.xskipper.parquet.encryption.footer.key&quot; -&gt; &quot;k1&quot;)\nxskipper.setConf(conf)\nxskipper\n  .indexBuilder()\n  // Add an encrypted MinMax index for temp\n  .addMinMaxIndex(&quot;temp&quot;, &quot;k2&quot;)\n  // Add a plaintext ValueList index for city\n  .addValueListIndex(&quot;city&quot;)\n  .build(reader).show(false)\n```</code></pre></div>\n<h4 id=\"sample-2---creating-metadata-with-plaintext-footer\" style=\"position:relative;\"><a href=\"#sample-2---creating-metadata-with-plaintext-footer\" aria-label=\"sample 2   creating metadata with plaintext footer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sample 2 - creating metadata with plaintext footer</h4>\n<p>=== “Python”</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">``` python\n# configure footer key\nconf = dict([(&quot;io.xskipper.parquet.encryption.footer.key&quot;, &quot;k1&quot;),\n(&quot;io.xskipper.parquet.encryption.plaintext.footer&quot;, &quot;true&quot;)])\nxskipper.setConf(conf)\n# adding the indexes\nxskipper.indexBuilder() \\\n.addMinMaxIndex(&quot;temp&quot;, &quot;k2&quot;) \\\n.addValueListIndex(&quot;city&quot;) \\\n.build(reader) \\\n.show(10, False)\n```</code></pre></div>\n<p>=== “Scala”</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">``` scala\n// set the footer key\nval conf = Map(\n&quot;io.xskipper.parquet.encryption.footer.key&quot; -&gt; &quot;k1&quot;,\n&quot;io.xskipper.parquet.encryption.plaintext.footer&quot; -&gt; &quot;true&quot;)\nxskipper.setConf(conf)\nxskipper\n.indexBuilder()\n// Add an encrypted MinMax index for temp\n.addMinMaxIndex(&quot;temp&quot;, &quot;k2&quot;)\n// Add a plaintext ValueList index for city\n.addValueListIndex(&quot;city&quot;)\n.build(reader).show(false)\n```</code></pre></div>\n<h3 id=\"query-flow\" style=\"position:relative;\"><a href=\"#query-flow\" aria-label=\"query flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query Flow</h3>\n<p>When running Queries, there is no practical difference between encrypted metadata and non-encrypted metadata.\nThe only addition is the need to configure PME.</p>\n<center>\n![Encrypted Index Query Flow](../img/encryption_query_flow.svg)\n</center>\n<h3 id=\"index-refresh-flow\" style=\"position:relative;\"><a href=\"#index-refresh-flow\" aria-label=\"index refresh flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Index Refresh Flow</h3>\n<p>!!! note\nWhen refreshing encrypted metadata, ALL keys used in the metadata (that is, keys to all indexes + footer key) need to be accessible.</p>\n<p>When refreshing encrypted metadata, no action is required except for PME configurations (KMS, auth etc.)</p>\n<center>\n![Encrypted Index Refresh Flow](../img/encryption_refresh_flow.svg)\n</center>","fields":{"srcLink":"https://github.com/xskipper-io/xskipper/blob/master/site/docs/api/encryption.md"},"frontmatter":{"title":"","description":null,"extraClasses":null,"banner":null}}},"pageContext":{"id":"fca7be92-c30c-5d1c-8226-f1a5f9524707"}},"staticQueryHashes":["1764348645","2823140819","3000541721","3606484676"]}